<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processo de Shipment - Sistema PA</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="../css/dahboard.css">
    <link rel="stylesheet" href="../css/shipment.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="../img/GZL - Logos_pages-to-jpg-0001.jpg" alt="Logo PA" class="sidebar-logo">
                <h2>Sistema PA</h2>
            </div>
            <ul class="sidebar-menu">
                <li><a href="dashboard.html"><i class="fas fa-home"></i> Início</a></li>
                <li class="active"><a href="shipment.html"><i class="fa fa-globe"></i> Shipment</a></li>
                <li><a href="#"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="cadastro_colaborador.html"><i class="fas fa-users"></i> Cadastrar Funcionários</a></li>
                <li><a href="buscar_funcionarios.html"><i class="fas fa-search"></i> Buscar Funcionários</a></li>
                <li><a href="painel_de_controle.html"><i class="fa fa-tasks"></i> Painel De Controle</a></li>
                <li><a href="historico.html"><i class="fas fa-history"></i> Histórico</a></li>
                <li><a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="main-header">
                <h1>Processo de Shipment</h1>
                <div class="user-info">
                    <span id="currentUser">Usuário Logado</span>
                </div>
            </header>

            <!-- Process Cards Container -->
            <div id="processCardsContainer" class="process-cards">
                <!-- Cards will be dynamically inserted here -->
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons" id="mainActionButtons">
                <button class="btn primary-btn" id="startShipmentProcessBtn">
                    <i class="fas fa-plus"></i> Novo Shipment
                </button>
            </div>

            <!-- Modal Iniciar Processo -->
            <div class="modal" id="startProcessModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Iniciar Processo de Shipment</h2>

                    <div id="startProcessFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="startProcessScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startProcessScannerBtn">
                            <i class="fas fa-qrcode"></i> Ler QR Code do Operador
                        </button>
                    </div>

                    <div id="operatorInfo" style="display: none; margin: 10px 0;">
                        Operador: <strong id="operatorName"></strong>
                    </div>

                    <div class="form-group">
                        <label for="shipmentNumber">Número do Shipment:</label>
                        <input type="text" id="shipmentNumber" placeholder="Digite o número do shipment" required>
                    </div>

                    <div class="form-group">
                        <label for="transportType">Tipo de Transporte:</label>
                        <select id="transportType" required>
                            <option value="">Selecione...</option>
                            <option value="maritimo">Marítimo</option>
                            <option value="rodoviario">Rodoviário</option>
                            <option value="aereo">Aéreo (Baú)</option>
                            <option value="sider">Aéreo (Sider)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="surfCode">Código SURF:</label>
                        <input type="text" id="surfCode" placeholder="Digite o código SURF" required>
                    </div>

                    <div class="form-group">
                        <label for="dock">Doca:</label>
                        <input type="text" id="dock" placeholder="Digite a doca" required>
                    </div>

                    <div class="form-group">
                        <label for="destination">Destino:</label>
                        <input type="text" id="destination" placeholder="Digite o destino" required>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelStartProcessBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmStartProcessBtn" disabled>Iniciar Processo</button>
                    </div>
                </div>
            </div>

            <!-- Modal QR Code Genérico -->
            <div class="modal" id="qrCodeModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2 id="qrCodeModalTitle">Ler QR Code</h2>

                    <div id="qrCodeFeedback" class="feedback"></div>

                    <div class="qr-scanner-container">
                        <video id="qrCodeScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startQrCodeScannerBtn">
                            <i class="fas fa-qrcode"></i> Ativar Leitor QR Code
                        </button>
                    </div>

                    <div id="qrCodeOperatorInfo" style="display: none; margin: 10px 0;">
                        Operador: <strong id="qrCodeOperatorName"></strong>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelQrCodeBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmQrCodeBtn" disabled>Confirmar</button>
                    </div>
                </div>
            </div>

            <!-- Modal Lacre -->
            <div class="modal" id="sealModal">
                <div class="modal-content">
                    <span class="close-modal">&times;</span>
                    <h2>Registrar Lacre</h2>

                    <div id="sealFeedback" class="feedback"></div>

                    <div class="form-group">
                        <label for="sealNumber">Número do Lacre:</label>
                        <input type="text" id="sealNumber" placeholder="Digite o número do lacre" required>
                    </div>

                    <div class="qr-scanner-container">
                        <video id="sealScanner" width="100%" playsinline></video>
                        <button class="btn primary-btn" id="startSealScannerBtn">
                            <i class="fas fa-qrcode"></i> Ler QR Code do Lacre
                        </button>
                    </div>

                    <div class="modal-actions">
                        <button class="btn secondary-btn" id="cancelSealBtn">Cancelar</button>
                        <button class="btn primary-btn" id="confirmSealBtn">Confirmar</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- QR Code Scanner -->
    <script src="https://rawgit.com/schmich/instascan-builds/master/instascan.min.js"></script>
    
    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAROtfqwCp2i2DVqqQDge6QueiNbmlPzuI",
            authDomain: "produtividade-pa.firebaseapp.com",
            projectId: "produtividade-pa",
            storageBucket: "produtividade-pa.appspot.com",
            messagingSenderId: "455228218660",
            appId: "1:455228218660:web:f48ae8a0a03ea1062ca7b1",
            measurementId: "G-3ER0DB83JV"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Variáveis 
        let currentUser = null;
        let currentScanner = null;
        let processes = {};
        let timers = {};
        let waitingTimers = {};

        // Elementos da página
        const elements = {
            // Main elements
            startShipmentProcessBtn: document.getElementById('startShipmentProcessBtn'),
            currentUser: document.getElementById('currentUser'),
            mainActionButtons: document.getElementById('mainActionButtons'),
            processCardsContainer: document.getElementById('processCardsContainer'),
            
            // Modals
            startProcessModal: document.getElementById('startProcessModal'),
            qrCodeModal: document.getElementById('qrCodeModal'),
            sealModal: document.getElementById('sealModal'),
            
            // Start Process Modal
            startProcessScanner: document.getElementById('startProcessScanner'),
            startProcessScannerBtn: document.getElementById('startProcessScannerBtn'),
            operatorName: document.getElementById('operatorName'),
            operatorInfo: document.getElementById('operatorInfo'),
            shipmentNumber: document.getElementById('shipmentNumber'),
            transportType: document.getElementById('transportType'),
            confirmStartProcessBtn: document.getElementById('confirmStartProcessBtn'),
            cancelStartProcessBtn: document.getElementById('cancelStartProcessBtn'),
            startProcessFeedback: document.getElementById('startProcessFeedback'),
            
            // QR Code Modal
            qrCodeModalTitle: document.getElementById('qrCodeModalTitle'),
            qrCodeScanner: document.getElementById('qrCodeScanner'),
            startQrCodeScannerBtn: document.getElementById('startQrCodeScannerBtn'),
            qrCodeOperatorName: document.getElementById('qrCodeOperatorName'),
            qrCodeOperatorInfo: document.getElementById('qrCodeOperatorInfo'),
            confirmQrCodeBtn: document.getElementById('confirmQrCodeBtn'),
            cancelQrCodeBtn: document.getElementById('cancelQrCodeBtn'),
            qrCodeFeedback: document.getElementById('qrCodeFeedback'),
            
            // Seal Modal
            sealNumber: document.getElementById('sealNumber'),
            sealScanner: document.getElementById('sealScanner'),
            startSealScannerBtn: document.getElementById('startSealScannerBtn'),
            confirmSealBtn: document.getElementById('confirmSealBtn'),
            cancelSealBtn: document.getElementById('cancelSealBtn'),
            sealFeedback: document.getElementById('sealFeedback'),
            
            // Others
            logoutBtn: document.getElementById('logoutBtn')
        };

        // Inicialização da página
        document.addEventListener('DOMContentLoaded', () => {
            // Verificar autenticação
            firebase.auth().onAuthStateChanged(user => {
                if (!user) {
                    window.location.href = 'index.html';
                } else {
                    currentUser = user;
                    elements.currentUser.textContent = user.displayName || user.email;
                    setupEventListeners();
                    loadActiveProcesses();
                }
            });
        });

        function setupEventListeners() {
            // Botão para iniciar processo
            elements.startShipmentProcessBtn.addEventListener('click', () => {
                resetStartProcessForm();
                elements.startProcessModal.style.display = 'flex';
            });
            
            // Modal Iniciar Processo
            elements.startProcessScannerBtn.addEventListener('click', () => startScanner('startProcess'));
            elements.cancelStartProcessBtn.addEventListener('click', () => {
                elements.startProcessModal.style.display = 'none';
                stopScanner();
            });
            elements.confirmStartProcessBtn.addEventListener('click', startShipmentProcess);
            
            // Modal QR Code Genérico
            elements.startQrCodeScannerBtn.addEventListener('click', () => startScanner('generic'));
            elements.cancelQrCodeBtn.addEventListener('click', () => {
                elements.qrCodeModal.style.display = 'none';
                stopScanner();
            });
            elements.confirmQrCodeBtn.addEventListener('click', confirmCurrentStep);
            
            // Modal Lacre
            elements.startSealScannerBtn.addEventListener('click', () => startScanner('seal'));
            elements.cancelSealBtn.addEventListener('click', () => {
                elements.sealModal.style.display = 'none';
                stopScanner();
            });
            elements.confirmSealBtn.addEventListener('click', confirmSeal);
            
            // Logout
            elements.logoutBtn.addEventListener('click', () => {
                firebase.auth().signOut().then(() => {
                    window.location.href = 'index.html';
                });
            });
        }

        function loadActiveProcesses() {
            db.ref('shipment_processes').orderByChild('createdBy').equalTo(currentUser.uid).on('value', snapshot => {
                if (snapshot.exists()) {
                    processes = {};
                    snapshot.forEach(processSnapshot => {
                        const processData = processSnapshot.val();
                        processes[processSnapshot.key] = {
                            ...processData,
                            id: processSnapshot.key
                        };
                        
                        // Iniciar temporizador se necessário
                        if (!timers[processSnapshot.key] && processData.status === 'in_progress') {
                            startProcessTimer(processSnapshot.key, processData.startTime || Date.now());
                        }
                        
                        // Iniciar temporizador de espera se necessário
                        if (processData.currentStep && processData.steps[processData.currentStep].status === 'in_progress') {
                            const stepData = processData.steps[processData.currentStep];
                            if (stepData.startTime && !stepData.endTime) {
                                startStepTimer(processSnapshot.key, processData.currentStep, stepData.startTime);
                            }
                        }
                    });
                    renderProcessCards();
                } else {
                    showNoProcessesMessage();
                }
            });
        }

        function renderProcessCards() {
            elements.processCardsContainer.innerHTML = '';
            
            if (Object.keys(processes).length === 0) {
                showNoProcessesMessage();
                return;
            }
            
            Object.values(processes).forEach(process => {
                const card = createProcessCard(process);
                elements.processCardsContainer.appendChild(card);
            });
        }

        function createProcessCard(process) {
            const card = document.createElement('div');
            card.className = 'process-card';
            card.dataset.processId = process.id;
            
            // Header
            const header = document.createElement('div');
            header.className = 'process-card-header';
            
            const title = document.createElement('h3');
            title.className = 'process-card-title';
            title.textContent = process.shipmentNumber;
            
            const status = document.createElement('span');
            status.className = `process-card-status ${process.status}`;
            status.textContent = getStatusLabel(process.status);
            
            header.appendChild(title);
            header.appendChild(status);
            
            // Body
            const body = document.createElement('div');
            body.className = 'process-card-body';
            
            const operator = document.createElement('div');
            operator.className = 'process-card-operator';
            operator.textContent = `Operador: ${process.operatorName}`;
            
            const transport = document.createElement('div');
            transport.className = 'process-card-transport';
            transport.textContent = `Transporte: ${getTransportLabel(process.transportType)}`;
            
            const details = document.createElement('div');
            details.className = 'process-card-details';
            details.innerHTML = `
                <div>Código SURF: ${process.surfCode}</div>
                <div>Doca: ${process.dock}</div>
                <div>Destino: ${process.destination}</div>
            `;
            
            // Timer
            const timer = document.createElement('div');
            timer.className = 'timer-display';
            timer.innerHTML = `Tempo total: <span id="timer-${process.id}">${formatTime(Math.floor(((process.endTime || Date.now()) - (process.startTime || Date.now())) / 1000))}</span>`;
            
            // Current step
            const currentStep = document.createElement('div');
            currentStep.className = 'step-title';
            currentStep.textContent = process.currentStep ? 
                getStepName(process.currentStep) : 'Processo concluído';
            
            // Step timer if in progress
            if (process.currentStep && process.steps[process.currentStep].status === 'in_progress') {
                const stepTimer = document.createElement('div');
                stepTimer.className = 'step-time-info';
                stepTimer.id = `step-timer-${process.id}-${process.currentStep}`;
                stepTimer.textContent = `Tempo da etapa: ${formatTime(Math.floor((Date.now() - (process.steps[process.currentStep].startTime || Date.now())) / 1000))}`;
                body.appendChild(stepTimer);
            }
            
            // Time metrics
            const timeMetrics = document.createElement('div');
            timeMetrics.className = 'time-metrics';
            
            // Add execution times for completed steps
            const stepsOrder = getStepsOrder(process.transportType);
            let previousStepEndTime = null;
            
            stepsOrder.forEach(stepId => {
                const step = process.steps[stepId];
                if (step && step.status === 'completed') {
                    // Execution time
                    const executionTimeDiv = document.createElement('div');
                    executionTimeDiv.className = 'time-metric';
                    executionTimeDiv.innerHTML = `
                        <span class="time-metric-label">${getStepName(stepId)}:</span>
                        <span class="time-metric-value">${formatTime(Math.floor((step.endTime - step.startTime) / 1000))}</span>
                    `;
                    timeMetrics.appendChild(executionTimeDiv);
                    
                    // Waiting time (if there's a next step)
                    const nextStepIndex = stepsOrder.indexOf(stepId) + 1;
                    if (nextStepIndex < stepsOrder.length) {
                        const nextStepId = stepsOrder[nextStepIndex];
                        const nextStep = process.steps[nextStepId];
                        if (nextStep && nextStep.status !== 'pending') {
                            const waitingTimeDiv = document.createElement('div');
                            waitingTimeDiv.className = 'time-metric';
                            waitingTimeDiv.innerHTML = `
                                <span class="time-metric-label">Espera ${getStepName(stepId)} → ${getStepName(nextStepId)}:</span>
                                <span class="time-metric-value">${formatTime(Math.floor((nextStep.startTime - step.endTime) / 1000))}</span>
                            `;
                            timeMetrics.appendChild(waitingTimeDiv);
                        }
                    }
                    
                    previousStepEndTime = step.endTime;
                }
            });
            
            body.appendChild(timeMetrics);
            
            // Actions
            const actions = document.createElement('div');
            actions.className = 'process-card-actions';
            
            if (process.status === 'completed') {
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn primary-btn';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i> Visualizar';
                viewBtn.addEventListener('click', () => viewProcessDetails(process.id));
                actions.appendChild(viewBtn);
            } else {
                // Adicionar botões para cada etapa
                addStepButtons(actions, process);
            }
            
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn danger-btn';
            cancelBtn.innerHTML = '<i class="fas fa-times"></i> Cancelar';
            cancelBtn.addEventListener('click', () => cancelProcess(process.id));
            actions.appendChild(cancelBtn);
            
            // Montar card
            body.appendChild(operator);
            body.appendChild(transport);
            body.appendChild(details);
            body.appendChild(timer);
            body.appendChild(currentStep);
            body.appendChild(actions);
            
            card.appendChild(header);
            card.appendChild(body);
            
            return card;
        }

        function addStepButtons(container, process) {
            const stepsOrder = getStepsOrder(process.transportType);
            const currentStepIndex = process.currentStep ? stepsOrder.indexOf(process.currentStep) : -1;
            
            if (currentStepIndex === -1) {
                // Processo não iniciado - mostrar botão para primeira etapa
                const startBtn = document.createElement('button');
                startBtn.className = 'btn primary-btn';
                startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Processo';
                startBtn.addEventListener('click', () => showQrCodeModal('Iniciar Processo', 'start', process.id));
                container.appendChild(startBtn);
            } else {
                const currentStep = stepsOrder[currentStepIndex];
                const stepData = process.steps[currentStep];
                
                if (stepData.status === 'in_progress') {
                    // Mostrar botão para finalizar etapa atual
                    const endBtn = document.createElement('button');
                    endBtn.className = 'btn primary-btn';
                    endBtn.innerHTML = '<i class="fas fa-stop"></i> Finalizar Etapa';
                    endBtn.addEventListener('click', () => showQrCodeModal(`Finalizar ${getStepName(currentStep)}`, 'complete', process.id));
                    container.appendChild(endBtn);
                } else if (stepData.status === 'pending') {
                    // Mostrar botão para iniciar etapa atual
                    const startBtn = document.createElement('button');
                    startBtn.className = 'btn primary-btn';
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Iniciar Etapa';
                    startBtn.addEventListener('click', () => showQrCodeModal(`Iniciar ${getStepName(currentStep)}`, 'start', process.id));
                    container.appendChild(startBtn);
                }
                
                // Se for etapa de lacre, mostrar botão específico
                if (currentStep === 'awaiting_seal') {
                    const sealBtn = document.createElement('button');
                    sealBtn.className = 'btn primary-btn';
                    sealBtn.innerHTML = '<i class="fas fa-lock"></i> Registrar Lacre';
                    sealBtn.addEventListener('click', () => showSealModal(process.id));
                    container.appendChild(sealBtn);
                }
            }
        }

        function showNoProcessesMessage() {
            elements.processCardsContainer.innerHTML = `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d;">
                    <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i>
                    <h3>Nenhum processo ativo</h3>
                    <p>Clique em "Novo Shipment" para iniciar um processo</p>
                </div>
            `;
        }

        function startProcessTimer(processId, startTime) {
            if (timers[processId]) {
                clearInterval(timers[processId]);
            }
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById(`timer-${processId}`);
                if (timerElement) {
                    timerElement.textContent = formatTime(elapsed);
                }
            };
            
            updateTimer();
            timers[processId] = setInterval(updateTimer, 1000);
        }

        function startStepTimer(processId, stepId, startTime) {
            const timerId = `${processId}-${stepId}`;
            if (waitingTimers[timerId]) {
                clearInterval(waitingTimers[timerId]);
            }
            
            const updateTimer = () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const timerElement = document.getElementById(`step-timer-${processId}-${stepId}`);
                if (timerElement) {
                    timerElement.textContent = `Tempo da etapa: ${formatTime(elapsed)}`;
                }
            };
            
            updateTimer();
            waitingTimers[timerId] = setInterval(updateTimer, 1000);
        }

        function showQrCodeModal(title, action, processId) {
            elements.qrCodeModalTitle.textContent = title;
            elements.qrCodeModal.dataset.action = action;
            elements.qrCodeModal.dataset.processId = processId;
            
            // Resetar o modal
            elements.qrCodeOperatorName.textContent = '';
            elements.qrCodeOperatorInfo.style.display = 'none';
            elements.confirmQrCodeBtn.disabled = true;
            elements.qrCodeFeedback.style.display = 'none';
            
            elements.qrCodeModal.style.display = 'flex';
        }

        function showSealModal(processId) {
            // Resetar o modal
            elements.sealNumber.value = '';
            elements.sealFeedback.style.display = 'none';
            elements.sealModal.dataset.processId = processId;
            
            elements.sealModal.style.display = 'flex';
        }

        function startScanner(type) {
            stopScanner();
            
            let scannerElement;
            switch (type) {
                case 'startProcess':
                    scannerElement = elements.startProcessScanner;
                    break;
                case 'generic':
                    scannerElement = elements.qrCodeScanner;
                    break;
                case 'seal':
                    scannerElement = elements.sealScanner;
                    break;
            }
            
            scannerElement.style.display = 'block';
            
            currentScanner = new Instascan.Scanner({
                video: scannerElement,
                mirror: false
            });
            
            currentScanner.addListener('scan', content => {
                handleQrScan(content, type);
            });
            
            Instascan.Camera.getCameras()
                .then(cameras => {
                    if (cameras.length === 0) {
                        throw new Error('Nenhuma câmera encontrada');
                    }
                    
                    const rearCamera = cameras.find(c => c.name.includes('traseira')) || 
                                     cameras.find(c => c.facing === 'environment') || 
                                     cameras[cameras.length - 1];
                    
                    return currentScanner.start(rearCamera);
                })
                .catch(error => {
                    console.error('Erro ao iniciar scanner:', error);
                    showFeedback('Erro ao acessar câmera: ' + error.message, 'error', 
                               type === 'startProcess' ? 'startProcessFeedback' : 
                               type === 'seal' ? 'sealFeedback' : 'qrCodeFeedback');
                });
        }

        function stopScanner() {
            if (currentScanner) {
                currentScanner.stop();
                currentScanner = null;
            }
            elements.startProcessScanner.style.display = 'none';
            elements.qrCodeScanner.style.display = 'none';
            elements.sealScanner.style.display = 'none';
        }

        function handleQrScan(content, type) {
            const qrCodeRegex = /^GZL-EO-\d{5}$/;
            if (!qrCodeRegex.test(content)) {
                showFeedback('QR Code inválido! Formato deve ser GZL-EO-XXXXX', 'error', 
                           type === 'startProcess' ? 'startProcessFeedback' : 
                           type === 'seal' ? 'sealFeedback' : 'qrCodeFeedback');
                return;
            }

            showFeedback('Validando QR Code...', 'info', 
                       type === 'startProcess' ? 'startProcessFeedback' : 
                       type === 'seal' ? 'sealFeedback' : 'qrCodeFeedback');

            db.ref('funcionarios').orderByChild('codigo').equalTo(content).once('value')
                .then(snapshot => {
                    if (!snapshot.exists()) {
                        throw new Error('Funcionário não encontrado');
                    }

                    let employeeData = null;
                    snapshot.forEach(child => {
                        employeeData = child.val();
                        return true;
                    });

                    if (type === 'startProcess') {
                        elements.operatorName.textContent = employeeData.nome;
                        elements.operatorInfo.style.display = 'block';
                        elements.confirmStartProcessBtn.disabled = false;
                        showFeedback('Operador validado com sucesso!', 'success', 'startProcessFeedback');
                        stopScanner();
                    } else if (type === 'seal') {
                        elements.sealNumber.value = content;
                        showFeedback('QR Code lido com sucesso!', 'success', 'sealFeedback');
                        stopScanner();
                    } else {
                        elements.qrCodeOperatorName.textContent = employeeData.nome;
                        elements.qrCodeOperatorInfo.style.display = 'block';
                        elements.confirmQrCodeBtn.disabled = false;
                        showFeedback('Operador validado com sucesso!', 'success', 'qrCodeFeedback');
                        stopScanner();
                    }
                })
                .catch(error => {
                    console.error('Erro ao validar QR Code:', error);
                    showFeedback('Erro: ' + error.message, 'error', 
                               type === 'startProcess' ? 'startProcessFeedback' : 
                               type === 'seal' ? 'sealFeedback' : 'qrCodeFeedback');
                });
        }

        function startShipmentProcess() {
            const operatorName = elements.operatorName.textContent;
            const shipmentNumber = elements.shipmentNumber.value.trim();
            const transportType = elements.transportType.value;
            const surfCode = document.getElementById('surfCode').value.trim();
            const dock = document.getElementById('dock').value.trim();
            const destination = document.getElementById('destination').value.trim();

            if (!operatorName || !shipmentNumber || !transportType || !surfCode || !dock || !destination) {
                showFeedback('Preencha todos os campos obrigatórios', 'error', 'startProcessFeedback');
                return;
            }

            // Verificar se já existe um processo com este número
            db.ref('shipment_processes').orderByChild('shipmentNumber').equalTo(shipmentNumber).once('value')
                .then(snapshot => {
                    if (snapshot.exists()) {
                        throw new Error('Já existe um processo com este número de remessa');
                    }

                    const stepsOrder = getStepsOrder(transportType);
                    const steps = {};
                    
                    stepsOrder.forEach(step => {
                        steps[step] = { 
                            name: getStepName(step), 
                            status: 'pending',
                            startTime: null,
                            endTime: null
                        };
                    });

                    const newProcess = {
                        operatorName,
                        shipmentNumber,
                        transportType,
                        surfCode,
                        dock,
                        destination,
                        status: 'pending',
                        steps,
                        createdBy: currentUser.uid,
                        createdAt: firebase.database.ServerValue.TIMESTAMP
                    };

                    const processRef = db.ref('shipment_processes').push();
                    return processRef.set(newProcess)
                        .then(() => {
                            showFeedback('Processo criado com sucesso!', 'success', 'startProcessFeedback');
                            setTimeout(() => {
                                elements.startProcessModal.style.display = 'none';
                                resetStartProcessForm();
                            }, 1500);
                        });
                })
                .catch(error => {
                    console.error('Erro ao iniciar processo:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'startProcessFeedback');
                });
        }

        function confirmCurrentStep() {
            const action = elements.qrCodeModal.dataset.action;
            const processId = elements.qrCodeModal.dataset.processId;
            const operatorName = elements.qrCodeOperatorName.textContent;
            
            if (!operatorName) {
                showFeedback('Escaneie o QR Code do operador', 'error', 'qrCodeFeedback');
                return;
            }
            
            if (!processes[processId]) {
                showFeedback('Processo não encontrado', 'error', 'qrCodeFeedback');
                return;
            }
            
            elements.confirmQrCodeBtn.disabled = true;
            const processRef = db.ref(`shipment_processes/${processId}`);
            const process = processes[processId];
            
            const updates = {};
            const now = firebase.database.ServerValue.TIMESTAMP;
            const stepsOrder = getStepsOrder(process.transportType);
            
            if (action === 'start') {
                const currentStep = process.currentStep || stepsOrder[0];
                updates[`steps/${currentStep}/status`] = 'in_progress';
                updates[`steps/${currentStep}/startTime`] = now;
                updates.currentStep = currentStep;
                
                if (process.status === 'pending') {
                    updates.status = 'in_progress';
                    updates.startTime = now;
                }
                
                processRef.update(updates)
                    .then(() => {
                        startStepTimer(processId, currentStep, now);
                        showFeedback('Etapa iniciada com sucesso!', 'success', 'qrCodeFeedback');
                        setTimeout(() => {
                            elements.qrCodeModal.style.display = 'none';
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Erro ao iniciar etapa:', error);
                        showFeedback('Erro: ' + error.message, 'error', 'qrCodeFeedback');
                        elements.confirmQrCodeBtn.disabled = false;
                    });
                
            } else if (action === 'complete') {
                const currentStep = process.currentStep;
                updates[`steps/${currentStep}/status`] = 'completed';
                updates[`steps/${currentStep}/endTime`] = now;
                
                // Determinar próxima etapa
                const currentIndex = stepsOrder.indexOf(currentStep);
                const nextStepId = stepsOrder[currentIndex + 1];
                
                if (nextStepId) {
                    // Não iniciamos automaticamente a próxima etapa
                    // Apenas marcamos a atual como concluída
                    updates.currentStep = nextStepId;
                } else {
                    // Todas as etapas concluídas
                    updates.status = 'completed';
                    updates.endTime = now;
                }
                
                processRef.update(updates)
                    .then(() => {
                        // Parar temporizador da etapa atual
                        const timerId = `${processId}-${currentStep}`;
                        if (waitingTimers[timerId]) {
                            clearInterval(waitingTimers[timerId]);
                            delete waitingTimers[timerId];
                        }
                        
                        showFeedback('Etapa concluída com sucesso!', 'success', 'qrCodeFeedback');
                        setTimeout(() => {
                            elements.qrCodeModal.style.display = 'none';
                            
                            // Se foi a última etapa, salvar no histórico
                            if (!nextStepId) {
                                saveProcessToHistory(processId);
                            }
                        }, 1500);
                    })
                    .catch(error => {
                        console.error('Erro ao concluir etapa:', error);
                        showFeedback('Erro: ' + error.message, 'error', 'qrCodeFeedback');
                        elements.confirmQrCodeBtn.disabled = false;
                    });
            }
        }

        function confirmSeal() {
            const processId = elements.sealModal.dataset.processId;
            const sealNumber = elements.sealNumber.value.trim();
            
            if (!sealNumber) {
                showFeedback('Informe o número do lacre', 'error', 'sealFeedback');
                return;
            }
            
            if (!processes[processId]) {
                showFeedback('Processo não encontrado', 'error', 'sealFeedback');
                return;
            }
            
            const processRef = db.ref(`shipment_processes/${processId}`);
            const now = firebase.database.ServerValue.TIMESTAMP;
            
            const updates = {
                'steps/awaiting_seal/status': 'completed',
                'steps/awaiting_seal/endTime': now,
                sealNumber,
                sealAppliedAt: now,
                status: 'completed',
                endTime: now
            };
            
            processRef.update(updates)
                .then(() => {
                    // Parar temporizador da etapa atual
                    const timerId = `${processId}-awaiting_seal`;
                    if (waitingTimers[timerId]) {
                        clearInterval(waitingTimers[timerId]);
                        delete waitingTimers[timerId];
                    }
                    
                    showFeedback('Lacre registrado com sucesso!', 'success', 'sealFeedback');
                    setTimeout(() => {
                        elements.sealModal.style.display = 'none';
                        saveProcessToHistory(processId);
                    }, 1500);
                })
                .catch(error => {
                    console.error('Erro ao registrar lacre:', error);
                    showFeedback('Erro: ' + error.message, 'error', 'sealFeedback');
                });
        }

        function saveProcessToHistory(processId) {
            if (!processes[processId]) return;
            
            const process = processes[processId];
            
            const historyData = {
                processId: process.id,
                operatorName: process.operatorName,
                shipmentNumber: process.shipmentNumber,
                transportType: process.transportType,
                surfCode: process.surfCode,
                dock: process.dock,
                destination: process.destination,
                startTime: process.startTime,
                endTime: process.endTime || firebase.database.ServerValue.TIMESTAMP,
                steps: {},
                totalDuration: (process.endTime || Date.now()) - process.startTime,
                sealNumber: process.sealNumber || null,
                sealAppliedAt: process.sealAppliedAt || null
            };
            
            // Calcular tempos para cada etapa e tempos de espera
            const stepsOrder = getStepsOrder(process.transportType);
            stepsOrder.forEach((stepId, index) => {
                const step = process.steps[stepId];
                if (step) {
                    historyData.steps[stepId] = {
                        name: step.name,
                        status: step.status,
                        startTime: step.startTime,
                        endTime: step.endTime,
                        executionTime: step.endTime && step.startTime ? step.endTime - step.startTime : null
                    };
                    
                    // Calcular tempo de espera entre etapas
                    if (index > 0 && step.startTime) {
                        const previousStepId = stepsOrder[index - 1];
                        const previousStep = process.steps[previousStepId];
                        if (previousStep && previousStep.endTime) {
                            historyData.steps[stepId].waitingTime = step.startTime - previousStep.endTime;
                        }
                    }
                }
            });
            
            db.ref('shipment_history').push(historyData)
                .then(() => {
                    db.ref(`shipment_processes/${processId}`).remove();
                });
        }

        function cancelProcess(processId) {
            if (!confirm('Tem certeza que deseja cancelar este processo?')) return;
            
            db.ref(`shipment_processes/${processId}`).remove()
                .catch(error => {
                    console.error('Erro ao cancelar processo:', error);
                    showFeedback('Erro ao cancelar processo: ' + error.message, 'error', 'qrCodeFeedback');
                });
        }

        function viewProcessDetails(processId) {
            // Implementar visualização de detalhes do processo concluído
            alert(`Visualizar detalhes do processo ${processId}`);
        }

        // Funções auxiliares
        function resetStartProcessForm() {
            elements.shipmentNumber.value = '';
            elements.transportType.value = '';
            document.getElementById('surfCode').value = '';
            document.getElementById('dock').value = '';
            document.getElementById('destination').value = '';
            elements.operatorName.textContent = '';
            elements.operatorInfo.style.display = 'none';
            elements.confirmStartProcessBtn.disabled = true;
            elements.startProcessFeedback.style.display = 'none';
            stopScanner();
        }

        function getStepsOrder(transportType) {
            const steps = {
                'maritimo': [
                    'loading',
                    'awaiting_seal'
                ],
                'rodoviario': [
                    'opening',
                    'loading',
                    'closing',
                    'pre_belt',
                    'awaiting_seal'
                ],
                'aereo': [
                    'loading',
                    'awaiting_seal'
                ],
                'sider': [
                    'opening',
                    'loading',
                    'closing',
                    'pre_belt',
                    'awaiting_seal'
                ]
            };
            return steps[transportType] || [];
        }

        function getStepName(stepId) {
            const stepNames = {
                'opening': 'Abertura',
                'loading': 'Carregamento',
                'closing': 'Fechamento',
                'pre_belt': 'Pré-Cinto',
                'awaiting_seal': 'Aguardando Lacre'
            };
            return stepNames[stepId] || stepId;
        }

        function getTransportLabel(transportType) {
            const labels = {
                'maritimo': 'Marítimo',
                'rodoviario': 'Rodoviário',
                'aereo': 'Aéreo (Baú)',
                'sider': 'Sider'
            };
            return labels[transportType] || transportType;
        }

        function getStatusLabel(status) {
            const labels = {
                'pending': 'Pendente',
                'in_progress': 'Em Andamento',
                'completed': 'Concluído'
            };
            return labels[status] || status;
        }

        function showFeedback(message, type, elementId) {
            const feedbackElement = document.getElementById(elementId);
            if (!feedbackElement) return;

            feedbackElement.textContent = message;
            feedbackElement.style.display = 'block';
            feedbackElement.className = `feedback ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    feedbackElement.style.display = 'none';
                }, 5000);
            }
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return "00:00:00";
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
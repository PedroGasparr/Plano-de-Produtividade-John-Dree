<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hist√≥rico - Sistema de Opera√ß√£o</title>
    <!-- Importar Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <!-- Biblioteca para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="../css/historico.css">
    <style>
        /* Reset e estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Navbar melhorada */
        .navbar {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6da7 100%);
            color: white;
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 0;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo span {
            color: #4CAF50;
        }

        .nav-links {
            display: flex;
            list-style: none;
            gap: 20px;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 10px 15px;
            border-radius: 6px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background: rgba(255,255,255,0.1);
            transform: translateY(-2px);
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            font-size: 14px;
        }

        .user-role {
            font-size: 12px;
            opacity: 0.8;
        }

        .change-unit-btn, .logout-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .change-unit-btn {
            background: rgba(255,255,255,0.1);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .change-unit-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .logout-btn {
            background: #e74c3c;
            color: white;
        }

        .logout-btn:hover {
            background: #c0392b;
            transform: translateY(-2px);
        }

        /* Conte√∫do principal */
        .content {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .page-title {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 20px;
            font-weight: 700;
        }

        .user-unit-info {
            background: white;
            padding: 15px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #4a6da7;
            font-weight: 600;
            color: #2c3e50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Se√ß√£o de senha */
        .password-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            text-align: center;
        }

        .password-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .password-section p {
            color: #666;
            margin-bottom: 20px;
            font-size: 16px;
        }

        .password-input {
            width: 300px;
            max-width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-right: 10px;
            transition: border-color 0.3s;
        }

        .password-input:focus {
            outline: none;
            border-color: #4a6da7;
        }

        .password-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .password-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(74, 109, 167, 0.3);
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-weight: 600;
            display: none;
        }

        /* Estilos para os cards de resumo */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            display: none;
        }

        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            border-left: 4px solid #4a6da7;
            transition: all 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }

        .summary-card h3 {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .summary-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
            line-height: 1.2;
        }

        .summary-card .sub-value {
            font-size: 14px;
            color: #666;
            font-weight: 500;
        }

        /* Cards espec√≠ficos para tipos de opera√ß√£o */
        .summary-card.simulacao { border-left-color: #4CAF50; }
        .summary-card.enderecamento { border-left-color: #2196F3; }
        .summary-card.shipment { border-left-color: #FF9800; }
        .summary-card.carregamento { border-left-color: #9C27B0; }

        /* Container principal do hist√≥rico */
        .history-container {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-top: 20px;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .history-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
        }

        .history-summary {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        /* Loading */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 50px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a6da7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 16px;
            font-weight: 500;
        }

        /* Tabela responsiva */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 8px;
            position: relative;
        }

        .history-table {
            width: 100%;
            min-width: 1200px;
            border-collapse: collapse;
        }

        .history-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .history-table td {
            padding: 16px 15px;
            border-bottom: 1px solid #eef0f3;
            vertical-align: middle;
        }

        .history-table tr:hover {
            background-color: #f8fafd;
        }

        /* Status badges */
        .status-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            display: inline-block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-completed { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; }
        .status-active { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; }
        .status-paused { background: linear-gradient(135deg, #FF9800 0%, #f57c00 100%); color: white; }

        /* Bot√µes de a√ß√£o */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .edit-btn, .delete-btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .edit-btn {
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
        }

        .edit-btn:hover {
            background: linear-gradient(135deg, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(58, 90, 143, 0.3);
        }

        .delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .expand-btn {
            background: none;
            border: none;
            color: #4a6da7;
            cursor: pointer;
            font-size: 18px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .expand-btn:hover {
            background: rgba(74, 109, 167, 0.1);
            transform: scale(1.1);
        }

        /* Linha de detalhes */
        .details-row {
            background: linear-gradient(135deg, #f8fafd 0%, #f0f4f8 100%);
        }

        .details-content {
            padding: 25px;
            border-top: 2px solid #eef0f3;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
        }

        .detail-group {
            margin-bottom: 20px;
        }

        .detail-label {
            font-weight: 700;
            color: #2c3e50;
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            color: #555;
            font-size: 15px;
            line-height: 1.6;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #eef0f3;
        }

        /* MODAIS - ATUALIZADOS E RESPONSIVOS */

        /* Modal base - responsivo e moderno */
        .modal-base {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-base.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content-base {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: translateY(-30px);
            opacity: 0;
            animation: slideUp 0.3s ease forwards;
            overflow: hidden;
        }

        @keyframes slideUp {
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header-base {
            padding: 25px 30px;
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title-base {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .close-btn-base {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-btn-base:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .modal-body-base {
            padding: 30px;
            flex: 1;
            overflow-y: auto;
        }

        .modal-actions-base {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #eef0f3;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* Modal de Edi√ß√£o */
        #editModal .modal-body-base {
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Modal de Confirma√ß√£o de Exclus√£o */
        #confirmDeleteModal .modal-content-base {
            max-width: 500px;
        }

        #confirmDeleteModal .modal-header-base {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .warning-icon {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
            color: #e74c3c;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .operation-info {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #ffeaea;
            max-height: 200px;
            overflow-y: auto;
        }

        .operation-info div {
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
            display: flex;
            justify-content: space-between;
        }

        .operation-info div:last-child {
            border-bottom: none;
        }

        .operation-info strong {
            color: #333;
            min-width: 120px;
        }

        /* Modal de Mudan√ßa de Unidade */
        #unitModal .modal-content-base {
            max-width: 400px;
        }

        /* Bot√µes dos modais */
        .modal-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            min-width: 120px;
        }

        .cancel-btn {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .cancel-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .save-btn {
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 109, 167, 0.3);
        }

        .confirm-delete-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .confirm-delete-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }

        .unit-confirm-btn {
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
        }

        .unit-confirm-btn:hover {
            background: linear-gradient(135deg, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 109, 167, 0.3);
        }

        /* Formul√°rios */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 15px;
        }

        .form-input, .unit-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        .form-input:focus, .unit-select:focus {
            outline: none;
            border-color: #4a6da7;
            box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.1);
        }

        textarea.form-input {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* Bot√µes de exporta√ß√£o */
        .export-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .export-btn {
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
            justify-content: center;
        }

        .pdf-btn {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .pdf-btn:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(231, 76, 60, 0.3);
        }

        .csv-btn {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .csv-btn:hover {
            background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(76, 175, 80, 0.3);
        }

        .csv-btn.full {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }

        .csv-btn.full:hover {
            background: linear-gradient(135deg, #1976D2 0%, #0d5ba8 100%);
        }

        /* Se√ß√£o de metas */
        .goals-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: none;
            border-left: 4px solid #4a6da7;
        }

        .goals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .goals-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .goal-input-group {
            margin-bottom: 20px;
        }

        .goal-label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 15px;
        }

        .goal-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
        }

        .goal-input:focus {
            outline: none;
            border-color: #4a6da7;
            box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.1);
        }

        .goal-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .save-goal-btn {
            padding: 14px 30px;
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .save-goal-btn:hover {
            background: linear-gradient(135deg, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 109, 167, 0.3);
        }

        .goal-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
            display: none;
        }

        .goal-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border-left: 4px solid #4a6da7;
            transition: all 0.3s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .goal-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .goal-card.achieved {
            border-left-color: #4CAF50;
            background: linear-gradient(135deg, #f1f8e9 0%, #e8f5e9 100%);
        }

        .goal-card.not-achieved {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #ffebee 0%, #fce4ec 100%);
        }

        .goal-card-value {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .goal-card-label {
            font-size: 13px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .goal-progress {
            margin-top: 30px;
            padding-top: 25px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 15px;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            transition: width 0.8s ease;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .progress-text {
            font-size: 14px;
            color: #666;
            text-align: center;
            font-weight: 600;
        }

        /* Filtros */
        .filters-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            display: none;
        }

        .filters-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .filters-title {
            font-size: 22px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-label {
            display: block;
            font-weight: 700;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 15px;
        }

        .filter-input, .filter-select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s;
            background: white;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #4a6da7;
            box-shadow: 0 0 0 3px rgba(74, 109, 167, 0.1);
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 30px;
            align-items: center;
            justify-content: space-between;
        }

        .filter-btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 700;
            transition: all 0.3s;
            min-width: 150px;
        }

        .clear-btn {
            background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%);
            color: white;
        }

        .clear-btn:hover {
            background: linear-gradient(135deg, #5a6268 0%, #495057 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        .apply-btn {
            background: linear-gradient(135deg, #4a6da7 0%, #3a5a8f 100%);
            color: white;
        }

        .apply-btn:hover {
            background: linear-gradient(135deg, #3a5a8f 0%, #2a4a7f 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(74, 109, 167, 0.3);
        }

        /* RESPONSIVIDADE COMPLETA */

        @media (max-width: 1200px) {
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .details-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            .nav-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .user-section {
                flex-wrap: wrap;
                justify-content: center;
                text-align: center;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .goals-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .export-buttons {
                flex-direction: column;
            }
            
            .export-btn {
                min-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .content {
                padding: 0 15px;
            }
            
            .modal-content-base {
                width: 95%;
                max-width: 95%;
                margin: 10px;
            }
            
            .modal-header-base {
                padding: 20px;
            }
            
            .modal-body-base {
                padding: 20px;
            }
            
            .modal-actions-base {
                padding: 15px 20px;
                flex-direction: column;
            }
            
            .modal-btn {
                width: 100%;
                min-width: auto;
            }
            
            .history-table th,
            .history-table td {
                padding: 12px 10px;
                font-size: 14px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 5px;
            }
            
            .edit-btn, .delete-btn {
                padding: 8px 12px;
                font-size: 12px;
                width: 100%;
                justify-content: center;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-buttons {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
                min-width: auto;
            }
            
            .password-input {
                width: 100%;
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .password-btn {
                width: 100%;
            }
            
            .goal-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .page-title {
                font-size: 24px;
            }
            
            .summary-card {
                padding: 20px;
            }
            
            .summary-card .value {
                font-size: 28px;
            }
            
            .history-title,
            .goals-title,
            .filters-title {
                font-size: 20px;
            }
            
            .goal-card {
                padding: 20px;
            }
            
            .goal-card-value {
                font-size: 28px;
            }
            
            .export-btn,
            .filter-btn,
            .save-goal-btn {
                padding: 12px 20px;
                font-size: 14px;
            }
            
            .modal-title-base {
                font-size: 18px;
            }
            
            .close-btn-base {
                width: 30px;
                height: 30px;
                font-size: 24px;
            }
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #4a6da7;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a5a8f;
        }

        /* Anima√ß√µes */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        /* Utilit√°rios */
        .hidden {
            display: none !important;
        }

        .visible {
            display: block !important;
        }

        .text-center {
            text-align: center;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Estilos para mensagens de erro */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .alert-error {
            background: linear-gradient(135deg, #ffeaea 0%, #ffcccc 100%);
            border-left: 4px solid #e74c3c;
            color: #c0392b;
        }

        .alert-success {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-left: 4px solid #4CAF50;
            color: #2e7d32;
        }

        .alert-warning {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-left: 4px solid #FF9800;
            color: #ef6c00;
        }

        /* Tooltip */
        [data-tooltip] {
            position: relative;
        }

        [data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 5px;
        }

        [data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
            margin-bottom: -5px;
        }
    </style>
</head>
<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <span>Prod</span>Plan
            </div>
            
            <ul class="nav-links">
                <li><a href="operacao.html">Opera√ß√£o</a></li>
                <li><a href="cadastrar_funcionario.html">Cadastrar Funcion√°rio</a></li>
                <li><a href="buscar_funcionario.html">Buscar Funcion√°rio</a></li>
                <li><a href="ranking.html">Ranking</a></li>
                <li><a href="painel_controle.html">Painel de Controle</a></li>
                <li><a href="historico.html" class="active">Hist√≥rico</a></li>
            </ul>
            
            <div class="user-section">
                <div class="user-info">
                    <div class="user-name">Carregando...</div>
                    <div class="user-role"></div>
                </div>
                <button class="change-unit-btn" id="changeUnitBtn" data-tooltip="Mudar unidade de trabalho">
                    üè¢ Mudar Unidade
                </button>
                <button class="logout-btn" data-tooltip="Sair do sistema">
                    üö™ Sair
                </button>
            </div>
        </div>
    </nav>
    
    <!-- CONTE√öDO PRINCIPAL -->
    <div class="content">
        <h1 class="page-title">Hist√≥rico de Opera√ß√µes</h1>
        
        <div class="user-unit-info" id="userUnitInfo">
            Carregando informa√ß√µes da unidade...
        </div>
        
        <!-- SE√á√ÉO DE SENHA -->
        <div class="password-section" id="passwordSection">
            <h2>üîê Acesso ao Hist√≥rico</h2>
            <p>Para acessar o hist√≥rico, digite a senha de administra√ß√£o:</p>
            <div style="margin: 25px 0;">
                <input type="password" id="passwordInput" class="password-input" 
                       placeholder="Digite a senha de administra√ß√£o" autocomplete="off">
                <button id="passwordBtn" class="password-btn">üîì Acessar</button>
            </div>
            <div class="error-message" id="passwordError"></div>
        </div>

        <!-- SE√á√ÉO DE METAS -->
        <div class="goals-section" id="goalsSection">
            <div class="goals-header">
                <h2 class="goals-title">üéØ Metas de Produ√ß√£o</h2>
            </div>
            
            <div class="goals-grid">
                <div class="goal-input-group">
                    <label class="goal-label">Meta Fixa (Toneladas)</label>
                    <input type="number" id="fixedGoal" class="goal-input" 
                           placeholder="Ex: 150" min="0" step="1">
                </div>
                
                <div class="goal-input-group">
                    <label class="goal-label">Meta do Dia (Toneladas)</label>
                    <input type="number" id="dailyGoal" class="goal-input" 
                           placeholder="Ex: 160" min="0" step="1">
                </div>
            </div>
            
            <div class="goal-actions">
                <button id="saveGoals" class="save-goal-btn">
                    üíæ Salvar Metas
                </button>
            </div>
            
            <div class="goal-cards" id="goalCards">
                <div class="goal-card" id="fixedGoalCard">
                    <div class="goal-card-value" id="fixedGoalValue">0</div>
                    <div class="goal-card-label">Meta Fixa</div>
                </div>
                
                <div class="goal-card" id="dailyGoalCard">
                    <div class="goal-card-value" id="dailyGoalValue">0</div>
                    <div class="goal-card-label">Meta do Dia</div>
                </div>
                
                <div class="goal-card" id="achievedCard">
                    <div class="goal-card-value" id="achievedValue">0</div>
                    <div class="goal-card-label">Realizado Hoje</div>
                </div>
                
                <div class="goal-card" id="progressCard">
                    <div class="goal-card-value" id="progressValue">0%</div>
                    <div class="goal-card-label">Progresso</div>
                </div>
            </div>
            
            <div class="goal-progress" id="goalProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progressText">
                    Meta do dia: <span id="currentDailyGoal">0</span> toneladas | 
                    Realizado: <span id="currentAchieved">0</span> toneladas
                </div>
            </div>
        </div>
        
        <!-- FILTROS -->
        <div class="filters-container" id="filtersContainer">
            <div class="filters-header">
                <h2 class="filters-title">üîç Filtros</h2>
            </div>
            
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">üìÖ Data Inicial</label>
                    <input type="date" id="startDate" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">üìÖ Data Final</label>
                    <input type="date" id="endDate" class="filter-input">
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">üìä Status</label>
                    <select id="statusFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="completed">‚úÖ Conclu√≠do</option>
                        <option value="active">‚ñ∂Ô∏è Em Andamento</option>
                        <option value="paused">‚è∏Ô∏è Pausado</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">üèóÔ∏è Tipo de Opera√ß√£o</label>
                    <select id="typeFilter" class="filter-select">
                        <option value="">Todos</option>
                        <option value="simulacao">üñ•Ô∏è Simula√ß√£o</option>
                        <option value="enderecamento">üìç Endere√ßamento/Locate</option>
                        <option value="shipment">üö¢ Shipment</option>
                        <option value="carregamento">üöõ Carregamento de Carga</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">üë∑ Colaborador</label>
                    <select id="employeeFilter" class="filter-select">
                        <option value="">Todos</option>
                        <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
                    </select>
                </div>
                
                <div class="filter-group">
                    <label class="filter-label">üö™ Doca</label>
                    <input type="text" id="dockFilter" class="filter-input" placeholder="N√∫mero da doca">
                </div>

                <div class="filter-group">
                    <label class="filter-label">üì¶ Shipment</label>
                    <input type="text" id="shipmentFilter" class="filter-input" 
                           placeholder="N√∫mero do shipment">
                </div>

                <div class="filter-group">
                    <label class="filter-label">üî¢ SURF</label>
                    <input type="text" id="surfFilter" class="filter-input" 
                           placeholder="N√∫mero SURF">
                </div>

                <div class="filter-group">
                    <label class="filter-label">üó∫Ô∏è Destino</label>
                    <input type="text" id="destinoFilter" class="filter-input" 
                           placeholder="Destino">
                </div>
            </div>
            
            <div class="filter-buttons">
                <div class="filter-actions">
                    <button id="clearFilters" class="filter-btn clear-btn">
                        üóëÔ∏è Limpar Filtros
                    </button>
                    <button id="applyFilters" class="filter-btn apply-btn">
                        ‚úÖ Aplicar Filtros
                    </button>
                </div>
                
                <div class="export-buttons">
                    <button id="generatePDF" class="export-btn pdf-btn">
                        üìÑ Exportar PDF
                    </button>
                    <button id="generateCSV" class="export-btn csv-btn">
                        üìä Exportar CSV (Filtrado)
                    </button>
                    <button id="generateFullCSV" class="export-btn csv-btn full">
                        üìà Exportar CSV Completo
                    </button>
                </div>
            </div>
        </div>

        <!-- CARDS DE RESUMO -->
        <div class="summary-cards" id="summaryCards">
            <div class="summary-card">
                <h3>‚è±Ô∏è Tempo Total</h3>
                <div class="value" id="totalTime">0h 0min</div>
                <div class="sub-value" id="totalMinutes">0 minutos</div>
            </div>
            
            <div class="summary-card">
                <h3>üìä Tempo M√©dio Geral</h3>
                <div class="value" id="avgTime">0h 0min</div>
                <div class="sub-value" id="avgMinutes">0 minutos</div>
            </div>
            
            <div class="summary-card">
                <h3>‚öñÔ∏è Volume Total Carregado</h3>
                <div class="value" id="totalTons">0</div>
                <div class="sub-value">toneladas</div>
            </div>
            
            <div class="summary-card">
                <h3>üß© Total de Mix</h3>
                <div class="value" id="totalMix">0</div>
                <div class="sub-value">tipos de material</div>
            </div>
            
            <div class="summary-card">
                <h3>üìã Opera√ß√µes Realizadas</h3>
                <div class="value" id="totalOperations">0</div>
                <div class="sub-value">opera√ß√µes conclu√≠das</div>
            </div>

            <div class="summary-card simulacao">
                <h3>üñ•Ô∏è Tempo M√©dio - Simula√ß√£o</h3>
                <div class="value" id="avgTimeSimulacao">0h 0min</div>
                <div class="sub-value" id="avgMinutesSimulacao">0 minutos</div>
            </div>
            
            <div class="summary-card enderecamento">
                <h3>üìç Tempo M√©dio - Endere√ßamento</h3>
                <div class="value" id="avgTimeEnderecamento">0h 0min</div>
                <div class="sub-value" id="avgMinutesEnderecamento">0 minutos</div>
            </div>
            
            <div class="summary-card shipment">
                <h3>üö¢ Tempo M√©dio - Shipment</h3>
                <div class="value" id="avgTimeShipment">0h 0min</div>
                <div class="sub-value" id="avgMinutesShipment">0 minutos</div>
            </div>
            
            <div class="summary-card carregamento">
                <h3>üöõ Tempo M√©dio - Carregamento</h3>
                <div class="value" id="avgTimeCarregamento">0h 0min</div>
                <div class="sub-value" id="avgMinutesCarregamento">0 minutos</div>
            </div>
        </div>
        
        <!-- HIST√ìRICO -->
        <div class="history-container" id="historyContainer">
            <div class="history-header">
                <h2 class="history-title">üìã Hist√≥rico de Opera√ß√µes</h2>
                <div class="history-summary" id="historySummary">Mostrando 0 registros</div>
            </div>
            
            <div class="loading" id="historyLoading">
                <div class="loading-spinner"></div>
            </div>
            
            <div class="no-data" id="historyNoData">
                Nenhum dado encontrado com os filtros aplicados.
            </div>
            
            <div class="table-container">
                <table class="history-table" id="historyTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;"></th>
                            <th>Data/Hora In√≠cio</th>
                            <th>Data/Hora Fim</th>
                            <th>Colaborador Principal</th>
                            <th>Outros Colaboradores</th>
                            <th>Tipo</th>
                            <th>Status</th>
                            <th>Doca</th>
                            <th>Destino</th>
                            <th>Shipment</th>
                            <th>Toneladas</th>
                            <th>Mix</th>
                            <th>Tempo Total</th>
                            <th style="min-width: 150px;">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Dados ser√£o preenchidos via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE EDI√á√ÉO -->
    <div class="modal-base" id="editModal">
        <div class="modal-content-base">
            <div class="modal-header-base">
                <h2 class="modal-title-base">‚úèÔ∏è Editar Opera√ß√£o</h2>
                <button class="close-btn-base" id="closeEditModal">&times;</button>
            </div>
            
            <div class="modal-body-base">
                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="editObservation" class="form-input" rows="4" 
                              placeholder="Adicione observa√ß√µes sobre a opera√ß√£o"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Toneladas</label>
                    <input type="number" id="editTons" class="form-input" 
                           step="0.1" placeholder="Ex: 25.5">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mix de Material</label>
                    <input type="number" id="editMix" class="form-input" 
                           placeholder="Ex: 3">
                </div>
            </div>
            
            <div class="modal-actions-base">
                <button class="modal-btn cancel-btn" id="cancelEdit">
                    ‚ùå Cancelar
                </button>
                <button class="modal-btn save-btn" id="saveEdit">
                    üíæ Salvar Altera√ß√µes
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE CONFIRMA√á√ÉO DE EXCLUS√ÉO -->
    <div class="modal-base" id="confirmDeleteModal">
        <div class="modal-content-base">
            <div class="modal-header-base">
                <h2 class="modal-title-base">‚ö†Ô∏è Confirmar Exclus√£o</h2>
                <button class="close-btn-base" id="closeConfirmModal">&times;</button>
            </div>
            
            <div class="modal-body-base">
                <div class="warning-icon">‚ö†Ô∏è</div>
                <p style="text-align: center; font-size: 16px; margin-bottom: 15px;">
                    <strong>Tem certeza que deseja excluir esta opera√ß√£o permanentemente?</strong>
                </p>
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    Esta a√ß√£o n√£o pode ser desfeita e todos os dados relacionados ser√£o perdidos.
                </p>
                
                <div class="operation-info" id="operationInfo">
                    <!-- Informa√ß√µes da opera√ß√£o ser√£o inseridas aqui -->
                </div>
                
                <p style="text-align: center; color: #e74c3c; font-weight: bold; margin-top: 20px;">
                    ‚ö†Ô∏è Aten√ß√£o: Esta √© uma a√ß√£o irrevers√≠vel!
                </p>
            </div>
            
            <div class="modal-actions-base">
                <button class="modal-btn cancel-btn" id="cancelDeleteBtn">
                    ‚ùå Cancelar
                </button>
                <button class="modal-btn confirm-delete-btn" id="confirmDeleteBtn">
                    üóëÔ∏è Excluir Permanentemente
                </button>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE MUDAN√áA DE UNIDADE -->
    <div class="modal-base" id="unitModal">
        <div class="modal-content-base">
            <div class="modal-header-base">
                <h2 class="modal-title-base">üè¢ Mudar Unidade</h2>
                <button class="close-btn-base" id="unitCloseBtn">&times;</button>
            </div>
            
            <div class="modal-body-base">
                <p style="margin-bottom: 20px; color: #666;">
                    Selecione a unidade para a qual deseja mudar:
                </p>
                <select id="unitSelect" class="unit-select">
                    <option value="">Selecione uma unidade</option>
                    <option value="Unidade Maracanau">Unidade Maracanau</option>
                    <option value="Unidade Belem">Unidade Belem</option>
                    <option value="Unidade Mogi Das Cruzes">Unidade Mogi Das Cruzes</option>
                    <option value="Unidade Imperatriz">Unidade Imperatriz</option>
                    <option value="Unidade Cariacica">Unidade Cariacica</option>
                    <option value="Unidade Aracruz">Unidade Aracruz</option>
                    <option value="Unidade Jonh Deere">Unidade Jonh Deere</option>
                    <option value="Unidade Teste">Unidade Teste</option>
                    <option value="Unidade Teste Jonh Dree">Unidade Teste Jonh Dree</option>
                </select>
            </div>
            
            <div class="modal-actions-base">
                <button class="modal-btn cancel-btn" id="unitCancelBtn">
                    ‚ùå Cancelar
                </button>
                <button class="modal-btn unit-confirm-btn" id="unitConfirmBtn">
                    ‚úÖ Confirmar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Configura√ß√£o do Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCMu17OV-5ST1rlg00zbpt6Hv37GKqkX4A",
            authDomain: "projetos-d868d.firebaseapp.com",
            databaseURL: "https://projetos-d868d-default-rtdb.firebaseio.com",
            projectId: "projetos-d868d",
            storageBucket: "projetos-d868d.firebasestorage.app",
            messagingSenderId: "420029352781",
            appId: "1:420029352781:web:05176699348e0ccdd78504",
            measurementId: "G-FXWXRX04WF"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Estado da aplica√ß√£o
        let currentUser = null;
        let userData = null;
        let currentUnit = '';
        let operationsData = [];
        let employeesData = [];
        let currentEditId = null;
        let currentDeleteId = null;
        let expandedRows = new Set();
        const ADMIN_PASSWORD = "195#%$*7advan!7";

        // Elementos da interface
        const elements = {
            userName: document.querySelector('.user-name'),
            userUnitInfo: document.getElementById('userUnitInfo'),
            passwordSection: document.getElementById('passwordSection'),
            passwordInput: document.getElementById('passwordInput'),
            passwordBtn: document.getElementById('passwordBtn'),
            passwordError: document.getElementById('passwordError'),
            filtersContainer: document.getElementById('filtersContainer'),
            historyContainer: document.getElementById('historyContainer'),
            historyLoading: document.getElementById('historyLoading'),
            historyNoData: document.getElementById('historyNoData'),
            historyTable: document.getElementById('historyTable'),
            historyTableBody: document.getElementById('historyTableBody'),
            historySummary: document.getElementById('historySummary'),
            editModal: document.getElementById('editModal'),
            confirmDeleteModal: document.getElementById('confirmDeleteModal'),
            unitModal: document.getElementById('unitModal'),
            summaryCards: document.getElementById('summaryCards'),
            goalsSection: document.getElementById('goalsSection'),
            goalCards: document.getElementById('goalCards'),
            goalProgress: document.getElementById('goalProgress'),
            currentGoals: null,
            todayAchieved: 0
        };

        // Inicializar aplica√ß√£o
        function initApp() {
            setupFirebaseAuth();
            setupEventListeners();
            setupModalListeners();
        }

        // Configurar autentica√ß√£o do Firebase
        function setupFirebaseAuth() {
            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    elements.userName.textContent = 'Carregando...';
                    loadUserData(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        // Carregar dados do usu√°rio
        async function loadUserData(uid) {
            try {
                const doc = await db.collection('users').doc(uid).get();
                if (doc.exists) {
                    userData = doc.data();
                    elements.userName.textContent = userData.name;
                    currentUnit = userData.unit;
                    elements.userUnitInfo.textContent = `üè¢ Unidade atual: ${currentUnit}`;
                    await loadEmployeesData();
                }
            } catch (error) {
                console.error("Erro ao carregar dados do usu√°rio:", error);
            }
        }

        // Carregar dados dos colaboradores
        async function loadEmployeesData() {
            try {
                const snapshot = await db.collection('colaboradores')
                    .where('unidade', '==', currentUnit)
                    .get();
                
                employeesData = [];
                const employeeFilter = document.getElementById('employeeFilter');
                employeeFilter.innerHTML = '<option value="">Todos</option>';
                
                snapshot.forEach((doc) => {
                    const data = { id: doc.id, ...doc.data() };
                    employeesData.push(data);
                    
                    const option = document.createElement('option');
                    option.value = data.codigo;
                    option.textContent = `${data.nome} (${data.codigo})`;
                    employeeFilter.appendChild(option);
                });
            } catch (error) {
                console.error("Erro ao carregar colaboradores:", error);
            }
        }

        // Configurar listeners de eventos
        function setupEventListeners() {
            // Senha
            elements.passwordBtn.addEventListener('click', checkPassword);
            elements.passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });

            // Filtros
            document.getElementById('applyFilters').addEventListener('click', applyFilters);
            document.getElementById('clearFilters').addEventListener('click', clearFilters);

            // Exporta√ß√£o
            document.getElementById('generatePDF').addEventListener('click', generatePDF);
            document.getElementById('generateCSV').addEventListener('click', generateCSV);
            document.getElementById('generateFullCSV').addEventListener('click', generateFullCSV);

            // Metas
            document.getElementById('saveGoals').addEventListener('click', saveGoals);

            // Mudan√ßa de unidade
            document.getElementById('changeUnitBtn').addEventListener('click', () => {
                showModal(elements.unitModal);
            });

            // Logout
            document.querySelector('.logout-btn').addEventListener('click', logout);
        }

        // Configurar listeners dos modais
        function setupModalListeners() {
            // Modal de edi√ß√£o
            document.getElementById('closeEditModal').addEventListener('click', () => hideModal(elements.editModal));
            document.getElementById('cancelEdit').addEventListener('click', () => hideModal(elements.editModal));
            document.getElementById('saveEdit').addEventListener('click', saveEdit);

            // Modal de confirma√ß√£o de exclus√£o
            document.getElementById('closeConfirmModal').addEventListener('click', () => hideModal(elements.confirmDeleteModal));
            document.getElementById('cancelDeleteBtn').addEventListener('click', () => hideModal(elements.confirmDeleteModal));
            document.getElementById('confirmDeleteBtn').addEventListener('click', confirmDeleteOperation);

            // Modal de unidade
            document.getElementById('unitCloseBtn').addEventListener('click', () => hideModal(elements.unitModal));
            document.getElementById('unitCancelBtn').addEventListener('click', () => hideModal(elements.unitModal));
            document.getElementById('unitConfirmBtn').addEventListener('click', confirmUnitChange);

            // Fechar modais ao clicar fora
            window.addEventListener('click', (e) => {
                if (e.target === elements.editModal) hideModal(elements.editModal);
                if (e.target === elements.confirmDeleteModal) hideModal(elements.confirmDeleteModal);
                if (e.target === elements.unitModal) hideModal(elements.unitModal);
            });

            // Fechar com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideModal(elements.editModal);
                    hideModal(elements.confirmDeleteModal);
                    hideModal(elements.unitModal);
                }
            });
        }

        // Fun√ß√µes para mostrar/esconder modais
        function showModal(modal) {
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideModal(modal) {
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Verificar senha
        function checkPassword() {
            const password = elements.passwordInput.value.trim();
            
            if (password === ADMIN_PASSWORD) {
                elements.passwordError.style.display = 'none';
                showMainContent();
                loadHistoryData();
                loadGoals();
            } else {
                elements.passwordError.textContent = '‚ùå Senha incorreta. Tente novamente.';
                elements.passwordError.style.display = 'block';
                elements.passwordInput.value = '';
                elements.passwordInput.focus();
            }
        }

        // Mostrar conte√∫do principal
        function showMainContent() {
            elements.passwordSection.style.display = 'none';
            elements.filtersContainer.style.display = 'block';
            elements.historyContainer.style.display = 'block';
            elements.summaryCards.style.display = 'grid';
            elements.goalsSection.style.display = 'block';
        }

        // Carregar dados do hist√≥rico
        async function loadHistoryData() {
            showHistoryLoading();
            
            try {
                const snapshot = await db.collection('operations')
                    .where('unit', '==', currentUnit)
                    .orderBy('createdAt', 'desc')
                    .get();
                
                operationsData = [];
                snapshot.forEach((doc) => {
                    operationsData.push({ id: doc.id, ...doc.data() });
                });
                
                applyFilters();
            } catch (error) {
                console.error("Erro ao carregar hist√≥rico:", error);
                showHistoryError('Erro ao carregar hist√≥rico.');
            }
        }

        // Aplicar filtros
        function applyFilters() {
            const filters = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('statusFilter').value,
                type: document.getElementById('typeFilter').value,
                employee: document.getElementById('employeeFilter').value,
                dock: document.getElementById('dockFilter').value.toLowerCase(),
                shipment: document.getElementById('shipmentFilter').value.toLowerCase(),
                surf: document.getElementById('surfFilter').value.toLowerCase(),
                destino: document.getElementById('destinoFilter').value.toLowerCase()
            };
            
            let filteredData = filterOperations(operationsData, filters);
            displayHistoryData(filteredData);
            updateSummaryCards(filteredData);
            calculateTodayAchieved(filteredData);
        }

        // Filtrar opera√ß√µes
        function filterOperations(data, filters) {
            return data.filter(op => {
                // Filtro por data
                if (filters.startDate || filters.endDate) {
                    const opDate = op.startTime ? op.startTime.toDate() : new Date(0);
                    
                    if (filters.startDate) {
                        const start = new Date(filters.startDate);
                        start.setHours(0, 0, 0, 0);
                        if (opDate < start) return false;
                    }
                    
                    if (filters.endDate) {
                        const end = new Date(filters.endDate);
                        end.setHours(23, 59, 59, 999);
                        if (opDate > end) return false;
                    }
                }
                
                // Filtros simples
                if (filters.status && op.status !== filters.status) return false;
                if (filters.type && op.type !== filters.type) return false;
                
                // Filtro por colaborador
                if (filters.employee && op.employeeCode !== filters.employee) {
                    if (!op.additionalLoaders || !op.additionalLoaders.includes(filters.employee)) {
                        return false;
                    }
                }
                
                // Filtros de texto
                if (filters.dock && !(op.doca || op.dock || '').toLowerCase().includes(filters.dock)) return false;
                if (filters.shipment && !(op.shipmentNumber || op.shipmentId || '').toLowerCase().includes(filters.shipment)) return false;
                if (filters.surf && !(op.surfNumber || op.surfCode || '').toLowerCase().includes(filters.surf)) return false;
                if (filters.destino && !(op.destino || op.destination || '').toLowerCase().includes(filters.destino)) return false;
                
                return true;
            });
        }

        // Exibir dados do hist√≥rico
        function displayHistoryData(data) {
            hideHistoryLoading();
            
            if (data.length === 0) {
                elements.historyNoData.style.display = 'block';
                elements.historyTable.style.display = 'none';
                elements.historySummary.textContent = 'Nenhum registro encontrado';
                return;
            }
            
            elements.historyNoData.style.display = 'none';
            elements.historyTable.style.display = 'table';
            elements.historySummary.textContent = `Mostrando ${data.length} de ${operationsData.length} registros`;
            
            elements.historyTableBody.innerHTML = '';
            data.forEach(operation => createTableRow(operation));
        }

        // Criar linha da tabela
        function createTableRow(operation) {
            const isExpanded = expandedRows.has(operation.id);
            
            // Formatar dados
            const startDate = formatDateTime(operation.startTime);
            const endDate = formatDateTime(operation.endTime, 'Em andamento');
            const employeeName = getEmployeeName(operation.employeeCode);
            const formattedType = getOperationType(operation.type);
            const formattedStatus = getStatusInfo(operation.status);
            const totalTime = calculateTotalTime(operation);
            
            // Linha principal
            const mainRow = document.createElement('tr');
            mainRow.innerHTML = `
                <td>
                    <button class="expand-btn" data-id="${operation.id}" data-tooltip="${isExpanded ? 'Recolher' : 'Expandir'}">
                        ${isExpanded ? '‚ñº' : '‚ñ∫'}
                    </button>
                </td>
                <td>${startDate}</td>
                <td>${endDate}</td>
                <td>${employeeName}</td>
                <td>${operation.additionalLoaders ? operation.additionalLoaders.join(', ') : 'Nenhum'}</td>
                <td>${formattedType.icon} ${formattedType.text}</td>
                <td><span class="status-badge ${formattedStatus.class}">${formattedStatus.text}</span></td>
                <td>${operation.doca || operation.dock || 'N/A'}</td>
                <td>${operation.destino || operation.destination || 'N/A'}</td>
                <td>${operation.shipmentNumber || 'N/A'}</td>
                <td>${operation.tonsLoaded || '0'}</td>
                <td>${operation.materialMix || '0'}</td>
                <td>${totalTime}</td>
                <td>
                    <div class="action-buttons">
                        <button class="edit-btn" data-id="${operation.id}" data-tooltip="Editar opera√ß√£o">
                            ‚úèÔ∏è Editar
                        </button>
                        <button class="delete-btn" data-id="${operation.id}" data-tooltip="Excluir opera√ß√£o">
                            üóëÔ∏è Excluir
                        </button>
                    </div>
                </td>
            `;
            
            elements.historyTableBody.appendChild(mainRow);
            
            // Linha de detalhes
            if (isExpanded) {
                createDetailsRow(operation);
            }
            
            // Adicionar event listeners
            mainRow.querySelector('.expand-btn').addEventListener('click', (e) => {
                toggleDetails(operation.id);
                e.stopPropagation();
            });
            
            mainRow.querySelector('.edit-btn').addEventListener('click', (e) => {
                openEditModal(operation.id);
                e.stopPropagation();
            });
            
            mainRow.querySelector('.delete-btn').addEventListener('click', (e) => {
                openDeleteConfirmModal(operation.id);
                e.stopPropagation();
            });
        }

        // Criar linha de detalhes
        function createDetailsRow(operation) {
            const detailsRow = document.createElement('tr');
            detailsRow.className = 'details-row';
            detailsRow.id = `details-${operation.id}`;
            
            let detailsHTML = '<td colspan="14"><div class="details-content"><div class="details-grid">';
            
            // Informa√ß√µes gerais
            detailsHTML += `
                <div class="detail-group">
                    <span class="detail-label">üÜî ID da Opera√ß√£o:</span>
                    <span class="detail-value">${operation.id}</span>
                </div>
                <div class="detail-group">
                    <span class="detail-label">üë§ Criado por:</span>
                    <span class="detail-value">${operation.createdBy || 'N/A'}</span>
                </div>
                <div class="detail-group">
                    <span class="detail-label">üìù Observa√ß√µes:</span>
                    <span class="detail-value">${operation.observation || 'Nenhuma'}</span>
                </div>
            `;
            
            // Informa√ß√µes espec√≠ficas
            if (operation.type === 'simulacao' && operation.endereco) {
                detailsHTML += `
                    <div class="detail-group">
                        <span class="detail-label">üìç Endere√ßo/√Årea:</span>
                        <span class="detail-value">${operation.endereco}</span>
                    </div>
                `;
            }
            
            if (operation.surfNumber) {
                detailsHTML += `
                    <div class="detail-group">
                        <span class="detail-label">üî¢ N√∫mero SURF:</span>
                        <span class="detail-value">${operation.surfNumber}</span>
                    </div>
                `;
            }
            
            if (operation.transportType) {
                detailsHTML += `
                    <div class="detail-group">
                        <span class="detail-label">üöö Tipo de Transporte:</span>
                        <span class="detail-value">${operation.transportType}</span>
                    </div>
                `;
            }
            
            if (operation.pauseReason) {
                detailsHTML += `
                    <div class="detail-group">
                        <span class="detail-label">‚è∏Ô∏è Motivo da Pausa:</span>
                        <span class="detail-value">${operation.pauseReason}</span>
                    </div>
                `;
            }
            
            if (operation.reopenReason) {
                detailsHTML += `
                    <div class="detail-group">
                        <span class="detail-label">‚ñ∂Ô∏è Motivo da Reabertura:</span>
                        <span class="detail-value">${operation.reopenReason}</span>
                    </div>
                `;
            }
            
            detailsHTML += '</div></div></td>';
            detailsRow.innerHTML = detailsHTML;
            elements.historyTableBody.appendChild(detailsRow);
        }

        // Fun√ß√µes auxiliares
        function formatDateTime(timestamp, defaultValue = 'N/A') {
            if (!timestamp) return defaultValue;
            return timestamp.toDate().toLocaleString('pt-BR');
        }

        function getEmployeeName(code) {
            const employee = employeesData.find(emp => emp.codigo === code);
            return employee ? `${employee.nome} (${code})` : code || 'N/A';
        }

        function getOperationType(type) {
            const types = {
                'simulacao': { icon: 'üñ•Ô∏è', text: 'Simula√ß√£o' },
                'enderecamento': { icon: 'üìç', text: 'Endere√ßamento' },
                'shipment': { icon: 'üö¢', text: 'Shipment' },
                'carregamento': { icon: 'üöõ', text: 'Carregamento' }
            };
            return types[type] || { icon: 'üìã', text: type };
        }

        function getStatusInfo(status) {
            const statuses = {
                'completed': { class: 'status-completed', text: '‚úÖ Conclu√≠do' },
                'active': { class: 'status-active', text: '‚ñ∂Ô∏è Em Andamento' },
                'paused': { class: 'status-paused', text: '‚è∏Ô∏è Pausado' }
            };
            return statuses[status] || { class: '', text: status };
        }

        function calculateTotalTime(operation) {
            if (!operation.startTime || !operation.endTime) return 'N/A';
            
            const start = operation.startTime.toDate();
            const end = operation.endTime.toDate();
            const duration = (end - start) / (1000 * 60); // minutos
            
            const hours = Math.floor(duration / 60);
            const minutes = Math.round(duration % 60);
            
            return `${hours}h ${minutes}min`;
        }

        // Alternar detalhes
        function toggleDetails(operationId) {
            if (expandedRows.has(operationId)) {
                expandedRows.delete(operationId);
            } else {
                expandedRows.add(operationId);
            }
            applyFilters();
        }

        // Abrir modal de edi√ß√£o
        function openEditModal(operationId) {
            const operation = operationsData.find(op => op.id === operationId);
            if (!operation) return;
            
            currentEditId = operationId;
            
            document.getElementById('editObservation').value = operation.observation || '';
            document.getElementById('editTons').value = operation.tonsLoaded || '';
            document.getElementById('editMix').value = operation.materialMix || '';
            
            showModal(elements.editModal);
        }

        // Salvar edi√ß√£o
        async function saveEdit() {
            if (!currentEditId) return;
            
            const updates = {
                observation: document.getElementById('editObservation').value,
                tonsLoaded: parseFloat(document.getElementById('editTons').value) || 0,
                materialMix: parseInt(document.getElementById('editMix').value) || 0,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const saveBtn = document.getElementById('saveEdit');
            saveBtn.textContent = 'üíæ Salvando...';
            saveBtn.disabled = true;
            
            try {
                await db.collection('operations').doc(currentEditId).update(updates);
                
                // Atualizar localmente
                const index = operationsData.findIndex(op => op.id === currentEditId);
                if (index !== -1) {
                    operationsData[index] = { ...operationsData[index], ...updates };
                }
                
                applyFilters();
                hideModal(elements.editModal);
                showAlert('‚úÖ Altera√ß√µes salvas com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao atualizar opera√ß√£o:", error);
                showAlert('‚ùå Erro ao salvar altera√ß√µes. Tente novamente.', 'error');
            } finally {
                saveBtn.textContent = 'üíæ Salvar Altera√ß√µes';
                saveBtn.disabled = false;
            }
        }

        // Abrir modal de confirma√ß√£o de exclus√£o
        function openDeleteConfirmModal(operationId) {
            const operation = operationsData.find(op => op.id === operationId);
            if (!operation) return;
            
            currentDeleteId = operationId;
            
            // Preencher informa√ß√µes
            const operationInfo = document.getElementById('operationInfo');
            const employeeName = getEmployeeName(operation.employeeCode);
            const formattedType = getOperationType(operation.type);
            
            operationInfo.innerHTML = `
                <div><strong>üÜî ID:</strong> ${operation.id.substring(0, 12)}...</div>
                <div><strong>üìÖ Data/Hora In√≠cio:</strong> ${formatDateTime(operation.startTime)}</div>
                <div><strong>üìÖ Data/Hora Fim:</strong> ${formatDateTime(operation.endTime, 'Em andamento')}</div>
                <div><strong>üë∑ Colaborador:</strong> ${employeeName}</div>
                <div><strong>üèóÔ∏è Tipo:</strong> ${formattedType.icon} ${formattedType.text}</div>
                <div><strong>üìä Status:</strong> ${getStatusInfo(operation.status).text}</div>
                <div><strong>üö™ Doca:</strong> ${operation.doca || operation.dock || 'N/A'}</div>
                <div><strong>üó∫Ô∏è Destino:</strong> ${operation.destino || operation.destination || 'N/A'}</div>
                <div><strong>üì¶ Shipment:</strong> ${operation.shipmentNumber || 'N/A'}</div>
                <div><strong>‚öñÔ∏è Toneladas:</strong> ${operation.tonsLoaded || '0'}</div>
                <div><strong>üß© Mix:</strong> ${operation.materialMix || '0'}</div>
            `;
            
            showModal(elements.confirmDeleteModal);
        }

        // Confirmar exclus√£o
        async function confirmDeleteOperation() {
            if (!currentDeleteId) return;
            
            const deleteBtn = document.getElementById('confirmDeleteBtn');
            deleteBtn.textContent = 'üóëÔ∏è Excluindo...';
            deleteBtn.disabled = true;
            
            try {
                await db.collection('operations').doc(currentDeleteId).delete();
                
                // Remover localmente
                const index = operationsData.findIndex(op => op.id === currentDeleteId);
                if (index !== -1) {
                    operationsData.splice(index, 1);
                }
                
                hideModal(elements.confirmDeleteModal);
                applyFilters();
                showAlert('‚úÖ Opera√ß√£o exclu√≠da com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao excluir opera√ß√£o:", error);
                showAlert('‚ùå Erro ao excluir opera√ß√£o. Tente novamente.', 'error');
            } finally {
                deleteBtn.textContent = 'üóëÔ∏è Excluir Permanentemente';
                deleteBtn.disabled = false;
            }
        }

        // Confirmar mudan√ßa de unidade
        async function confirmUnitChange() {
            const selectedUnit = document.getElementById('unitSelect').value;
            
            if (!selectedUnit) {
                showAlert('‚ùå Por favor, selecione uma unidade.', 'error');
                return;
            }
            
            if (selectedUnit === currentUnit) {
                hideModal(elements.unitModal);
                return;
            }
            
            const confirmBtn = document.getElementById('unitConfirmBtn');
            confirmBtn.textContent = 'üîÑ Alterando...';
            confirmBtn.disabled = true;
            
            try {
                await db.collection('users').doc(currentUser.uid).update({
                    unit: selectedUnit,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentUnit = selectedUnit;
                elements.userUnitInfo.textContent = `üè¢ Unidade atual: ${currentUnit}`;
                
                // Recarregar dados
                await loadEmployeesData();
                if (elements.historyContainer.style.display !== 'none') {
                    await loadHistoryData();
                }
                
                hideModal(elements.unitModal);
                showAlert(`‚úÖ Unidade alterada para: ${selectedUnit}`, 'success');
            } catch (error) {
                console.error("Erro ao atualizar unidade:", error);
                showAlert('‚ùå Erro ao alterar unidade. Tente novamente.', 'error');
            } finally {
                confirmBtn.textContent = '‚úÖ Confirmar';
                confirmBtn.disabled = false;
            }
        }

        // Atualizar cards de resumo
        function updateSummaryCards(data) {
            const completedOperations = data.filter(op => op.status === 'completed');
            
            // Calcular totais
            const totals = completedOperations.reduce((acc, op) => {
                acc.tons += op.tonsLoaded || 0;
                acc.mix += op.materialMix || 0;
                
                if (op.startTime && op.endTime) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    const duration = (end - start) / (1000 * 60);
                    acc.minutes += duration;
                }
                
                return acc;
            }, { tons: 0, mix: 0, minutes: 0 });
            
            const count = completedOperations.length;
            
            // Atualizar elementos
            document.getElementById('totalTons').textContent = totals.tons.toFixed(1);
            document.getElementById('totalMix').textContent = totals.mix;
            document.getElementById('totalOperations').textContent = count;
            
            // Formatando tempo
            const totalHours = Math.floor(totals.minutes / 60);
            const totalMins = Math.round(totals.minutes % 60);
            document.getElementById('totalTime').textContent = `${totalHours}h ${totalMins}min`;
            document.getElementById('totalMinutes').textContent = `${Math.round(totals.minutes)} minutos`;
            
            const avgMinutes = count > 0 ? totals.minutes / count : 0;
            const avgHours = Math.floor(avgMinutes / 60);
            const avgMins = Math.round(avgMinutes % 60);
            document.getElementById('avgTime').textContent = `${avgHours}h ${avgMins}min`;
            document.getElementById('avgMinutes').textContent = `${Math.round(avgMinutes)} minutos`;
            
            // Calcular por tipo
            calculateAverageTimeByType(completedOperations);
        }

        // Calcular tempo m√©dio por tipo
        function calculateAverageTimeByType(completedOperations) {
            const types = ['simulacao', 'enderecamento', 'shipment', 'carregamento'];
            const elementsMap = {
                'simulacao': { time: 'avgTimeSimulacao', minutes: 'avgMinutesSimulacao' },
                'enderecamento': { time: 'avgTimeEnderecamento', minutes: 'avgMinutesEnderecamento' },
                'shipment': { time: 'avgTimeShipment', minutes: 'avgMinutesShipment' },
                'carregamento': { time: 'avgTimeCarregamento', minutes: 'avgMinutesCarregamento' }
            };
            
            types.forEach(type => {
                const typeOperations = completedOperations.filter(op => op.type === type);
                const typeData = calculateTypeData(typeOperations);
                const elements = elementsMap[type];
                
                if (elements) {
                    document.getElementById(elements.time).textContent = typeData.time;
                    document.getElementById(elements.minutes).textContent = typeData.minutes;
                }
            });
        }

        function calculateTypeData(operations) {
            const totalMinutes = operations.reduce((sum, op) => {
                if (op.startTime && op.endTime) {
                    const start = op.startTime.toDate();
                    const end = op.endTime.toDate();
                    return sum + (end - start) / (1000 * 60);
                }
                return sum;
            }, 0);
            
            const count = operations.length;
            const avgMinutes = count > 0 ? totalMinutes / count : 0;
            const hours = Math.floor(avgMinutes / 60);
            const minutes = Math.round(avgMinutes % 60);
            
            return {
                time: `${hours}h ${minutes}min`,
                minutes: `${Math.round(avgMinutes)} minutos (${count} ops)`
            };
        }

        // Sistema de metas
        async function loadGoals() {
            const today = new Date().toISOString().split('T')[0];
            
            try {
                const snapshot = await db.collection('daily_goals')
                    .where('unit', '==', currentUnit)
                    .where('date', '==', today)
                    .where('createdBy', '==', currentUser.uid)
                    .get();
                
                if (!snapshot.empty) {
                    const doc = snapshot.docs[0];
                    elements.currentGoals = { id: doc.id, ...doc.data() };
                    document.getElementById('fixedGoal').value = elements.currentGoals.fixedGoal || '150';
                    document.getElementById('dailyGoal').value = elements.currentGoals.dailyGoal || '';
                }
            } catch (error) {
                console.error("Erro ao carregar metas:", error);
            }
        }

        function calculateTodayAchieved(filteredData = operationsData) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            const todayOperations = filteredData.filter(op => {
                if (op.status !== 'completed' || !op.endTime) return false;
                const opDate = op.endTime.toDate();
                return opDate >= today && opDate < tomorrow;
            });
            
            elements.todayAchieved = todayOperations.reduce((sum, op) => sum + (op.tonsLoaded || 0), 0);
            updateGoalsDisplay();
        }

        async function saveGoals() {
            const fixedGoal = parseInt(document.getElementById('fixedGoal').value) || 0;
            const dailyGoal = parseInt(document.getElementById('dailyGoal').value) || 0;
            const today = new Date().toISOString().split('T')[0];
            
            if (fixedGoal <= 0 || dailyGoal <= 0) {
                showAlert('‚ùå Por favor, informe metas v√°lidas.', 'error');
                return;
            }
            
            const goalData = {
                unit: currentUnit,
                date: today,
                fixedGoal: fixedGoal,
                dailyGoal: dailyGoal,
                createdBy: currentUser.uid,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            const saveBtn = document.getElementById('saveGoals');
            saveBtn.textContent = 'üíæ Salvando...';
            saveBtn.disabled = true;
            
            try {
                if (elements.currentGoals && elements.currentGoals.id) {
                    await db.collection('daily_goals').doc(elements.currentGoals.id).update(goalData);
                } else {
                    const docRef = await db.collection('daily_goals').add(goalData);
                    elements.currentGoals = { id: docRef.id, ...goalData };
                }
                
                calculateTodayAchieved();
                showAlert('‚úÖ Metas salvas com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao salvar metas:", error);
                showAlert('‚ùå Erro ao salvar metas. Tente novamente.', 'error');
            } finally {
                saveBtn.textContent = 'üíæ Salvar Metas';
                saveBtn.disabled = false;
            }
        }

        function updateGoalsDisplay() {
            if (!elements.currentGoals) return;
            
            const fixedGoal = elements.currentGoals.fixedGoal || 0;
            const dailyGoal = elements.currentGoals.dailyGoal || 0;
            const progress = dailyGoal > 0 ? (elements.todayAchieved / dailyGoal) * 100 : 0;
            const isAchieved = elements.todayAchieved >= dailyGoal;
            
            // Atualizar valores
            document.getElementById('fixedGoalValue').textContent = fixedGoal;
            document.getElementById('dailyGoalValue').textContent = dailyGoal;
            document.getElementById('achievedValue').textContent = elements.todayAchieved.toFixed(1);
            document.getElementById('progressValue').textContent = `${Math.min(progress, 100).toFixed(1)}%`;
            document.getElementById('currentDailyGoal').textContent = dailyGoal;
            document.getElementById('currentAchieved').textContent = elements.todayAchieved.toFixed(1);
            
            // Atualizar barra de progresso
            document.getElementById('progressFill').style.width = `${Math.min(progress, 100)}%`;
            
            // Atualizar classes dos cards
            const cards = {
                'fixedGoalCard': 'goal-card',
                'dailyGoalCard': 'goal-card',
                'achievedCard': isAchieved ? 'goal-card achieved' : 'goal-card not-achieved',
                'progressCard': isAchieved ? 'goal-card achieved' : 'goal-card not-achieved'
            };
            
            Object.entries(cards).forEach(([id, className]) => {
                document.getElementById(id).className = className;
            });
            
            // Mostrar elementos
            elements.goalCards.style.display = 'grid';
            elements.goalProgress.style.display = 'block';
        }

        // Limpar filtros
        function clearFilters() {
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('employeeFilter').value = '';
            document.getElementById('dockFilter').value = '';
            document.getElementById('shipmentFilter').value = '';
            document.getElementById('surfFilter').value = '';
            document.getElementById('destinoFilter').value = '';
            
            applyFilters();
        }

        // Exporta√ß√£o
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // T√≠tulo
            doc.setFontSize(20);
            doc.text('Relat√≥rio de Opera√ß√µes', 148, 15, { align: 'center' });
            
            // Informa√ß√µes
            doc.setFontSize(12);
            doc.text(`Unidade: ${currentUnit}`, 14, 25);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 14, 32);
            
            // Dados da tabela
            const tableData = getFilteredData().map(op => {
                const start = formatDateTime(op.startTime);
                const end = formatDateTime(op.endTime, 'Em andamento');
                const employeeName = getEmployeeName(op.employeeCode);
                
                return [
                    start,
                    end,
                    employeeName,
                    getOperationType(op.type).text,
                    getStatusInfo(op.status).text,
                    op.doca || op.dock || 'N/A',
                    op.destino || op.destination || 'N/A',
                    op.shipmentNumber || 'N/A',
                    op.tonsLoaded || '0',
                    op.materialMix || '0'
                ];
            });
            
            // Adicionar tabela
            doc.autoTable({
                startY: 40,
                head: [['In√≠cio', 'Fim', 'Colaborador', 'Tipo', 'Status', 'Doca', 'Destino', 'Shipment', 'Toneladas', 'Mix']],
                body: tableData,
                styles: { fontSize: 8 },
                headStyles: { fillColor: [74, 109, 167] }
            });
            
            // Salvar
            const filename = `relatorio_operacoes_${currentUnit}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(filename);
            
            showAlert('‚úÖ PDF exportado com sucesso!', 'success');
        }

        function generateCSV() {
            const data = getFilteredData();
            exportToCSV(data, 'filtrado');
        }

        function generateFullCSV() {
            exportToCSV(operationsData, 'completo');
        }

        function exportToCSV(data, tipo = 'filtrado') {
            if (data.length === 0) {
                showAlert('‚ùå N√£o h√° dados para exportar.', 'error');
                return;
            }
            
            const headers = [
                'ID',
                'Data/Hora In√≠cio',
                'Data/Hora Fim',
                'Colaborador Principal',
                'Colaborador Principal C√≥digo',
                'Outros Colaboradores',
                'Tipo de Opera√ß√£o',
                'Status',
                'Doca',
                'Destino',
                'Shipment',
                'SURF',
                'Toneladas',
                'Mix de Material',
                'Tempo Total (min)',
                'Observa√ß√µes',
                'Motivo de Pausa',
                'Motivo da Reabertura',
                'Endere√ßo/√Årea',
                'Tipo de Transporte',
                'Shipment ID',
                'Unidade',
                'Data de Cria√ß√£o'
            ];
            
            const csvData = data.map(operation => {
                const start = formatDateTime(operation.startTime, '');
                const end = formatDateTime(operation.endTime, '');
                const employeeName = getEmployeeName(operation.employeeCode);
                const typeText = getOperationType(operation.type).text;
                const statusText = getStatusInfo(operation.status).text;
                
                // Calcular tempo total
                let totalMinutes = 0;
                if (operation.startTime && operation.endTime) {
                    const startDate = operation.startTime.toDate();
                    const endDate = operation.endTime.toDate();
                    totalMinutes = Math.round((endDate - startDate) / (1000 * 60));
                }
                
                return [
                    operation.id,
                    `"${start}"`,
                    `"${end}"`,
                    `"${employeeName}"`,
                    operation.employeeCode || '',
                    `"${operation.additionalLoaders ? operation.additionalLoaders.join('; ') : ''}"`,
                    typeText,
                    statusText,
                    operation.doca || operation.dock || '',
                    operation.destino || operation.destination || '',
                    operation.shipmentNumber || '',
                    operation.surfNumber || operation.surfCode || '',
                    operation.tonsLoaded || '0',
                    operation.materialMix || '0',
                    totalMinutes,
                    `"${operation.observation || ''}"`,
                    `"${operation.pauseReason || ''}"`,
                    `"${operation.reopenReason || ''}"`,
                    `"${operation.endereco || ''}"`,
                    operation.transportType || '',
                    operation.shipmentId || '',
                    operation.unit || currentUnit,
                    `"${operation.createdAt ? operation.createdAt.toDate().toLocaleString('pt-BR') : ''}"`
                ];
            });
            
            let csvContent = headers.join(',') + '\n';
            csvData.forEach(row => {
                csvContent += row.join(',') + '\n';
            });
            
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const today = new Date().toISOString().split('T')[0];
            link.setAttribute('href', url);
            link.setAttribute('download', `historico_operacoes_${currentUnit}_${today}_${tipo}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
            
            showAlert(`‚úÖ CSV exportado com sucesso! ${data.length} registros exportados.`, 'success');
        }

        function getFilteredData() {
            const filters = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                status: document.getElementById('statusFilter').value,
                type: document.getElementById('typeFilter').value,
                employee: document.getElementById('employeeFilter').value,
                dock: document.getElementById('dockFilter').value.toLowerCase(),
                shipment: document.getElementById('shipmentFilter').value.toLowerCase(),
                surf: document.getElementById('surfFilter').value.toLowerCase(),
                destino: document.getElementById('destinoFilter').value.toLowerCase()
            };
            
            return filterOperations(operationsData, filters);
        }

        // Fun√ß√µes auxiliares de UI
        function showHistoryLoading() {
            elements.historyLoading.style.display = 'flex';
            elements.historyNoData.style.display = 'none';
            elements.historyTable.style.display = 'none';
        }

        function hideHistoryLoading() {
            elements.historyLoading.style.display = 'none';
        }

        function showHistoryError(message) {
            elements.historyLoading.style.display = 'none';
            elements.historyNoData.textContent = message;
            elements.historyNoData.style.display = 'block';
            elements.historyTable.style.display = 'none';
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} fade-in`;
            alertDiv.innerHTML = message;
            
            // Remover alertas anteriores
            document.querySelectorAll('.alert').forEach(alert => alert.remove());
            
            document.body.appendChild(alertDiv);
            
            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Logout
        function logout() {
            if (confirm('Tem certeza que deseja sair do sistema?')) {
                auth.signOut().then(() => {
                    window.location.href = 'index.html';
                }).catch((error) => {
                    console.error('Erro ao fazer logout:', error);
                    showAlert('‚ùå Erro ao fazer logout.', 'error');
                });
            }
        }

        // Inicializar aplica√ß√£o quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>